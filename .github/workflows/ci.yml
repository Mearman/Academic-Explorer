name: 'CI Pipeline'

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for same workflow + branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.16.1'
  # Optional: Add Nx Cloud tokens for distributed caching
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_CLOUD_ENCRYPTION_KEY: ${{ secrets.NX_CLOUD_ENCRYPTION_KEY }}

jobs:
  # Main CI job following Nx best practices
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use tree:0 filter for optimal performance with full git history for Nx affected
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Setup Nx SHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'main'

      - name: Restore Nx cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('nx.json', '**/project.json', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-nx-${{ hashFiles('nx.json', '**/project.json') }}-
            ${{ runner.os }}-nx-

      # Run affected tasks using Nx's built-in parallelization
      - name: Build affected projects
        run: pnpm nx affected -t build --parallel=3
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Lint affected projects
        continue-on-error: true
        run: |
          # Get affected projects safely
          echo "Checking for affected projects..."
          affected_output=$(pnpm nx show projects --affected --json 2>/dev/null | tail -n 1 || echo '[]')
          affected_projects=$(echo "$affected_output" | jq -r '.[]' 2>/dev/null || echo "")
          echo "Affected projects: $affected_projects"

          # Use direct ESLint for web app to avoid Nx hanging issues
          if echo "$affected_projects" | grep -q "web" 2>/dev/null; then
            echo "Linting web app directly"
            cd apps/web
            timeout 5m pnpm eslint . --max-warnings=100 || { echo "Lint failed for web app, continuing..."; true; }
            cd ../..
          fi

          # Lint packages using direct ESLint
          if echo "$affected_projects" | grep -E "(client|utils|graph|simulation|ui)" > /dev/null 2>&1; then
            echo "Linting affected packages"
            for project in client utils graph simulation ui; do
              if echo "$affected_projects" | grep -q "$project" 2>/dev/null && [ -d "packages/$project" ]; then
                echo "Linting $project..."
                cd "packages/$project"
                timeout 3m pnpm eslint . --max-warnings=200 || { echo "Lint failed for $project, continuing..."; true; }
                cd ../..
              fi
            done
          else
            echo "No affected packages need linting or linting all essential packages..."
            # Lint essential packages regardless
            for project in client utils; do
              if [ -d "packages/$project" ]; then
                echo "Linting essential package: $project..."
                cd "packages/$project"
                timeout 3m pnpm eslint . --max-warnings=200 || { echo "Lint failed for $project, continuing..."; true; }
                cd ../..
              fi
            done
          fi
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Type check affected projects
        run: pnpm nx affected -t typecheck --parallel=3
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Test affected projects
        run: |
          # Run only stable package tests in CI
          echo "Checking for affected projects..."
          affected_output=$(pnpm nx show projects --affected --json 2>/dev/null | tail -n 1 || echo '[]')
          echo "Raw affected output: $affected_output"

          affected_projects=$(echo "$affected_output" | jq -r '.[]' 2>/dev/null || echo "")
          echo "Affected projects: $affected_projects"

          if echo "$affected_projects" | grep -E "(client|utils)" > /dev/null 2>&1; then
            echo "Running tests for stable packages only (client and utils)"
            timeout 10m pnpm nx run-many -t test --parallel=3 --projects=client,utils
          else
            echo "No affected stable projects need testing, checking if any packages need testing..."
            # Always run essential package tests to ensure they still work
            if [ -d "packages/client" ] && [ -d "packages/utils" ]; then
              echo "Running essential package tests to maintain CI reliability"
              timeout 10m pnpm nx run-many -t test --parallel=3 --projects=client,utils
            else
              echo "No test packages available"
            fi
          fi
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            apps/*/dist
            packages/*/dist
          retention-days: 1

  # Workspace quality checks (run always)
  workspace-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Check for unused dependencies
        run: pnpm knip
        continue-on-error: true

      - name: Verify licenses
        run: pnpm licenses:check

      - name: Verify workspace structure
        run: pnpm nx graph --file=graph.json && echo "✅ Workspace graph generated successfully"

  # E2E and accessibility tests (only if build succeeded)
  extended-checks:
    needs: ci
    if: success()
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [test:e2e, test:a11y]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Setup Nx SHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'main'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: Run ${{ matrix.check }}
        run: pnpm nx affected -t ${{ matrix.check }} --parallel=2
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

  # Release automation (main branch only)
  release:
    needs: [ci, workspace-quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run Nx release
        run: pnpm nx release --skip-publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: '--max-old-space-size=8192'

  # Deploy to GitHub Pages (main branch only)
  deploy:
    needs: [ci, workspace-quality, release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-pnpm

      - name: Build production app
        run: pnpm nx build web
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/web/dist
          cname: academic-explorer.joenash.uk

  # Aggregate status check for branch protection
  ci-success:
    runs-on: ubuntu-latest
    needs: [ci, workspace-quality, extended-checks, release, deploy]
    if: always()
    steps:
      - name: Check CI status
        run: |
          # Check required jobs
          if [[ "${{ needs.ci.result }}" != "success" ]]; then
            echo "❌ Main CI job failed"
            exit 1
          fi

          if [[ "${{ needs.workspace-quality.result }}" != "success" ]]; then
            echo "❌ Workspace quality checks failed"
            exit 1
          fi

          # Extended checks are optional (may be skipped)
          if [[ "${{ needs.extended-checks.result }}" == "failure" ]]; then
            echo "❌ Extended checks failed"
            exit 1
          fi

          # Release and deploy are main-branch only (may be skipped on PRs)
          if [[ "${{ needs.release.result }}" == "failure" ]]; then
            echo "❌ Release job failed"
            exit 1
          fi

          if [[ "${{ needs.deploy.result }}" == "failure" ]]; then
            echo "❌ Deploy job failed"
            exit 1
          fi

          echo "✅ All CI checks passed successfully"