name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run knip in dry-run mode (no PR creation)'
        required: false
        default: false
        type: boolean
  schedule:
    # Run knip analysis every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

env:
  NODE_VERSION: 20.x
  PNPM_VERSION: 10.16.1

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      cache-key: ${{ steps.cache-keys.outputs.cache-key }}
      nx-cache-key: ${{ steps.cache-keys.outputs.nx-cache-key }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Generate cache keys
        id: cache-keys
        run: |
          echo "cache-key=node-modules-${{ hashFiles('pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT
          echo "nx-cache-key=nx-${{ runner.os }}-${{ hashFiles('nx.json', 'package.json', 'pnpm-lock.yaml', '**/tsconfig.json', 'vite.config.ts') }}" >> $GITHUB_OUTPUT

      - name: Cache node_modules
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ steps.cache-keys.outputs.cache-key }}
          restore-keys: |
            node-modules-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: pnpm install --no-frozen-lockfile

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ steps.cache-keys.outputs.nx-cache-key }}
          restore-keys: |
            nx-${{ runner.os }}-

  eslint-autofix:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Only run on push events and if commit doesn't contain [skip lint-fix]
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip lint-fix]')

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Run ESLint with auto-fix
        run: pnpm nx lint:fix
        continue-on-error: true

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Files changed by ESLint auto-fix:"
            git status --porcelain
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No files were changed by ESLint auto-fix"
          fi

      - name: Configure Git
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git add .
          git commit -m "style: auto-fix ESLint issues [skip lint-fix]

          Automatically applied ESLint fixes via GitHub Actions.

          - Applied auto-fixable ESLint rules
          - Triggered by commit: ${{ github.event.head_commit.message }}
          - SHA: ${{ github.sha }}"
          git push

      - name: Summary
        run: |
          echo "## ESLint Auto-fix Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "âœ… ESLint fixes were applied and committed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Changes pushed to ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No ESLint fixes were needed" >> $GITHUB_STEP_SUMMARY
          fi

  quality-checks:
    needs: [setup, eslint-autofix]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Skip if eslint-autofix was skipped, otherwise run always
    if: always() && (needs.eslint-autofix.result == 'success' || needs.eslint-autofix.result == 'skipped')

    strategy:
      matrix:
        check: [lint, build, typecheck]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch latest changes if eslint-autofix made commits
          ref: ${{ github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Nx cache
        uses: actions/cache/restore@v4
        with:
          path: .nx/cache
          key: ${{ needs.setup.outputs.nx-cache-key }}
          restore-keys: |
            ${{ needs.setup.outputs.nx-cache-key }}-
            nx-${{ runner.os }}-${{ hashFiles('nx.json', 'package.json', 'pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages first (if typecheck)
        if: matrix.check == 'typecheck'
        run: pnpm nx build

      - name: Run ${{ matrix.check }}
        run: pnpm nx ${{ matrix.check }}
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload build artifact
        if: matrix.check == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: apps/web/dist/
          retention-days: 1
          compression-level: 6

      - name: Save Nx cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .nx/cache
          key: ${{ needs.setup.outputs.nx-cache-key }}-${{ matrix.check }}-${{ github.run_id }}-${{ github.run_attempt }}

  test:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration]
        include:
          - test-type: unit
            command: test:unit:run
            timeout: 10
          - test-type: integration
            command: test:integration:run
            timeout: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Restore Nx cache
        uses: actions/cache/restore@v4
        with:
          path: .nx/cache
          key: ${{ needs.setup.outputs.nx-cache-key }}
          restore-keys: |
            ${{ needs.setup.outputs.nx-cache-key }}-
            nx-${{ runner.os }}-${{ hashFiles('nx.json', 'package.json', 'pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-

      # E2E test setup removed - no E2E tests currently exist
      # TODO: Re-enable when actual E2E tests are implemented

      - name: Run ${{ matrix.test-type }} tests
        run: timeout ${{ matrix.timeout }}m pnpm nx ${{ matrix.command }}
        env:
          NODE_OPTIONS: "--max-old-space-size=8192 --expose-gc"

      - name: Upload coverage artifact
        if: always() && matrix.test-type == 'unit'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.test-type }}-${{ github.sha }}
          path: coverage/
          retention-days: 7

      - name: Save Nx cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .nx/cache
          key: ${{ needs.setup.outputs.nx-cache-key }}-${{ matrix.test-type }}-${{ github.run_id }}-${{ github.run_attempt }}

  coverage-report:
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    if: always() && (needs.test.result == 'success' || needs.test.result == 'failure')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download coverage artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: coverage-unit-${{ github.sha }}
          path: coverage-reports/
          merge-multiple: true

      - name: Create coverage summary
        run: npx tsx tools/scripts/create-coverage-summary.ts

      - name: Generate coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          npx tsx tools/scripts/generate-coverage-report.ts summary >> $GITHUB_STEP_SUMMARY

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        run: npx tsx tools/scripts/manage-coverage-comments.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}

  acknowledgements:
    needs: [setup, quality-checks]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Only run on dependency changes or manual trigger
    if: >
      (github.event_name == 'push' &&
       (contains(github.event.head_commit.message, 'package.json') ||
        contains(github.event.head_commit.message, 'pnpm-lock.yaml') ||
        contains(github.event.head_commit.message, '[update-ack]'))) ||
      github.event_name == 'workflow_dispatch'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Check for problematic licenses
        run: pnpm licenses:check

      - name: Generate acknowledgements
        run: |
          echo "Generating acknowledgements for production dependencies..."
          pnpm licenses:generate > temp_ack.md

          # Add header and metadata
          cat > ACKNOWLEDGEMENTS.md << EOF
          # Third-Party Acknowledgements

          This document acknowledges the third-party packages used in this project and their licenses.

          **Generated on:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Dependencies analyzed:** Production dependencies only
          **Last updated:** Commit $(git rev-parse --short HEAD)

          ---

          EOF

          cat temp_ack.md >> ACKNOWLEDGEMENTS.md
          rm temp_ack.md

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet ACKNOWLEDGEMENTS.md; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes in acknowledgements"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in acknowledgements"
            echo "Changes:"
            git diff --no-color ACKNOWLEDGEMENTS.md | head -20
          fi

      - name: Configure git
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit acknowledgements
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git add ACKNOWLEDGEMENTS.md

          COMMIT_MSG="chore(deps): update third-party acknowledgements

          - Updated acknowledgements for production dependencies
          - Generated from $(git log -1 --pretty=format:'%s' HEAD)
          - Analysis timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          [skip ci]"

          git commit -m "$COMMIT_MSG"

      - name: Push changes to current branch
        if: steps.check-changes.outputs.changes == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          git push origin ${{ github.ref_name }}

      - name: Create pull request for other branches
        if: steps.check-changes.outputs.changes == 'true' && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update third-party acknowledgements"
          title: "ðŸ”„ Update Third-Party Acknowledgements"
          body: |
            ## ðŸ“‹ Acknowledgements Update

            This PR updates the third-party acknowledgements file based on current production dependencies.

            ### Changes
            - âœ… Scanned production dependencies only
            - âœ… Excluded private packages
            - âœ… Verified license compatibility
            - ðŸ•’ Generated during CI run

            ### License Status
            All included packages use approved licenses (MIT, Apache-2.0, BSD, ISC, etc.)

            ---
            *This PR was automatically generated by the CI workflow.*
          branch: update-acknowledgements
          delete-branch: true

      - name: Add job summary
        if: always()
        run: |
          echo "## ðŸ“‹ Acknowledgements Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "âœ… **Changes detected and committed**" >> $GITHUB_STEP_SUMMARY
            echo "- Updated ACKNOWLEDGEMENTS.md with current dependencies" >> $GITHUB_STEP_SUMMARY
            echo "- All licenses passed compatibility check" >> $GITHUB_STEP_SUMMARY

            if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/develop" ]; then
              echo "- Changes pushed directly to ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Created pull request for review" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **No changes needed**" >> $GITHUB_STEP_SUMMARY
            echo "- Acknowledgements are up to date" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  accessibility:
    needs: [setup, quality-checks]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Install Chrome for accessibility testing
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Download build artifact
        uses: actions/download-artifact@v5
        with:
          name: dist-${{ github.sha }}
          path: dist/

      - name: Start preview server for accessibility testing
        run: pnpm nx preview &
        env:
          NODE_OPTIONS: "--max-old-space-size=6144"

      - name: Wait for preview server to be ready
        run: |
          echo "Waiting for preview server to start..."
          timeout 30 bash -c 'until curl -f http://localhost:4173 > /dev/null 2>&1; do sleep 1; done'
          echo "Preview server responding, waiting for app to be ready..."
          timeout 30 bash -c 'until curl -s http://localhost:4173 | grep -q "Academic Explorer\|<div id=\"root\""; do sleep 2; done'
          echo "Preview server and app are ready"

      - name: Run accessibility tests
        run: pnpm nx a11y:ci
        env:
          NODE_OPTIONS: "--max-old-space-size=6144"
          CHROME_PATH: "/usr/bin/google-chrome-stable"
          PUPPETEER_EXECUTABLE_PATH: "/usr/bin/google-chrome-stable"

      - name: Upload accessibility reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-reports-${{ github.sha }}
          path: |
            .lighthouseci/
            pa11y-results.json
          retention-days: 7

  release:
    needs: [setup, quality-checks, test, accessibility]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: write
      issues: write
      pull-requests: write

    outputs:
      released: ${{ steps.create-releases.outputs.release_created }}
      tag: ${{ steps.create-releases.outputs.release_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Run Nx Release
        id: nx-release
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Run nx release version (updates files but doesn't commit)
          pnpm release:version --skip-publish --dry-run

          # Check if there are actual changes to make
          if pnpm release:version --skip-publish 2>&1 | grep -q "No changes to version"; then
            echo "release_created=false" >> $GITHUB_OUTPUT
            echo "No version changes needed"
            exit 0
          fi

          echo "release_created=true" >> $GITHUB_OUTPUT

          # Get the new versions that would be created
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

          echo "Nx Release would create version: $NEW_VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub releases
        id: create-releases
        if: steps.nx-release.outputs.release_created == 'true'
        run: |
          # Create tags and GitHub releases
          pnpm release:publish

          echo "release_created=true" >> $GITHUB_OUTPUT
          echo "release_tag=${{ steps.nx-release.outputs.release_tag }}" >> $GITHUB_OUTPUT
          echo "new_version=${{ steps.nx-release.outputs.new_version }}" >> $GITHUB_OUTPUT

          echo "Created GitHub releases with tags"

      - name: Update version and create follow-up commit
        if: steps.create-releases.outputs.release_created == 'true'
        run: |
          # Check if there are changes from nx release version
          if git diff --quiet HEAD; then
            echo "No changes to commit - nx release didn't update files"
            exit 0
          fi

          # Stage all changes from nx release
          git add .

          # Create follow-up commit with version bumps and changelog updates
          git commit -m "chore(release): bump versions [skip ci]

          Automated version bumps and changelog updates:
          - Updated package versions via nx release
          - Generated changelogs for affected packages
          - Release: ${{ steps.create-releases.outputs.release_tag }}"

          # Push the follow-up commit
          git push origin main

      - name: Build for release
        if: steps.create-releases.outputs.release_created == 'true'
        run: |
          # Rebuild with the updated version
          pnpm nx build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload build artifact for deployment
        if: steps.create-releases.outputs.release_created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dist-release-${{ github.run_id }}
          path: apps/web/dist/
          retention-days: 1
          compression-level: 6

  deploy:
    needs: [release]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    if: needs.release.outputs.released == 'true'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v5
        with:
          name: dist-release-${{ github.run_id }}
          path: dist/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: dist/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  knip-analysis:
    needs: [setup, quality-checks]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Only run on scheduled events (weekly) or manual dispatch
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ needs.setup.outputs.cache-key }}
          fail-on-cache-miss: true

      - name: Run knip analysis
        id: knip-run
        run: |
          echo "ðŸ” Running knip analysis..."

          if pnpm knip --reporter json > knip-report.json 2>&1; then
            echo "knip_exit_code=0" >> $GITHUB_OUTPUT
            echo "âœ… Knip analysis completed successfully"
          else
            echo "knip_exit_code=$?" >> $GITHUB_OUTPUT
            echo "âš ï¸ Knip found unused code"
          fi

          if [ -s knip-report.json ] && [ "$(jq '.issues | length' knip-report.json 2>/dev/null || echo 0)" -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Knip found unused code to clean up"

            UNUSED_FILES=$(jq -r '.issues[] | select(.type == "unlisted") | .file' knip-report.json 2>/dev/null | wc -l || echo 0)
            UNUSED_DEPS=$(jq -r '.issues[] | select(.type == "dependencies") | .dependencies[]?' knip-report.json 2>/dev/null | wc -l || echo 0)
            UNUSED_EXPORTS=$(jq -r '.issues[] | select(.type == "exports") | .exports[]?' knip-report.json 2>/dev/null | wc -l || echo 0)

            echo "unused_files=$UNUSED_FILES" >> $GITHUB_OUTPUT
            echo "unused_deps=$UNUSED_DEPS" >> $GITHUB_OUTPUT
            echo "unused_exports=$UNUSED_EXPORTS" >> $GITHUB_OUTPUT

            echo "## ðŸ§¹ Knip Analysis Summary" > knip-summary.md
            echo "" >> knip-summary.md
            echo "Knip found the following unused code:" >> knip-summary.md
            echo "- ðŸ“ Unused files: $UNUSED_FILES" >> knip-summary.md
            echo "- ðŸ“¦ Unused dependencies: $UNUSED_DEPS" >> knip-summary.md
            echo "- ðŸ”— Unused exports: $UNUSED_EXPORTS" >> knip-summary.md
            echo "" >> knip-summary.md

            if [ "$UNUSED_FILES" -gt 0 ]; then
              echo "### Unused Files" >> knip-summary.md
              jq -r '.issues[] | select(.type == "unlisted") | "- `" + .file + "`"' knip-report.json >> knip-summary.md
              echo "" >> knip-summary.md
            fi

            if [ "$UNUSED_DEPS" -gt 0 ]; then
              echo "### Unused Dependencies" >> knip-summary.md
              jq -r '.issues[] | select(.type == "dependencies") | .dependencies[]? | "- `" + . + "`"' knip-report.json >> knip-summary.md
              echo "" >> knip-summary.md
            fi

            if [ "$UNUSED_EXPORTS" -gt 0 ]; then
              echo "### Unused Exports" >> knip-summary.md
              jq -r '.issues[] | select(.type == "exports") | .exports[]? | "- `" + .symbol + "` in `" + .file + "`"' knip-report.json >> knip-summary.md
            fi
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "âœ¨ No unused code found!"
          fi

      - name: Create cleanup branch and apply fixes
        if: steps.knip-run.outputs.has_issues == 'true' && !inputs.dry_run
        id: apply-fixes
        run: |
          BRANCH_NAME="chore/knip-cleanup-$(date +%Y%m%d-%H%M%S)"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b "$BRANCH_NAME"

          echo "ðŸ”§ Applying knip fixes..."
          if pnpm knip --fix; then
            echo "âœ… Automatic fixes applied successfully"

            if git diff --quiet; then
              echo "changes_made=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No changes were made by knip --fix"
            else
              echo "changes_made=true" >> $GITHUB_OUTPUT
              echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

              git add .
              git commit -m "chore: remove unused code detected by knip

              This commit removes unused code identified by knip analysis:
              - Unused files: ${{ steps.knip-run.outputs.unused_files }}
              - Unused dependencies: ${{ steps.knip-run.outputs.unused_deps }}
              - Unused exports: ${{ steps.knip-run.outputs.unused_exports }}

              Generated automatically by CI workflow."

              echo "ðŸ§ª Running verification tests..."
              if pnpm typecheck && pnpm build && pnpm test && pnpm lint; then
                echo "âœ… All tests passed after cleanup"
                git push origin "$BRANCH_NAME"
                echo "ðŸ“¤ Pushed changes to branch"
              else
                echo "âŒ Tests failed after cleanup"
                exit 1
              fi
            fi
          else
            echo "âŒ Failed to apply automatic fixes"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.apply-fixes.outputs.changes_made == 'true'
        run: |
          PR_TITLE="ðŸ§¹ chore: automated code cleanup via knip"

          PR_BODY="## ðŸ¤– Automated Code Cleanup

          This PR was automatically created by the CI workflow to remove unused code.

          $(cat knip-summary.md)

          ## âœ… Verification

          - [x] Knip analysis completed
          - [x] Automatic fixes applied
          - [x] TypeScript compilation passes
          - [x] Build succeeds
          - [x] Tests pass
          - [x] Linting passes

          ## ðŸ“‹ Manual Review Needed

          Please review the changes to ensure:
          - No critical code was accidentally removed
          - All functionality still works as expected
          - The cleanup aligns with project goals

          ---
          ðŸ¤– Generated by CI workflow"

          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ steps.apply-fixes.outputs.branch_name }}" \
            --label "automated" \
            --label "chore" \
            --label "knip"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload knip report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: knip-report-${{ github.run_id }}
          path: |
            knip-report.json
            knip-summary.md
          retention-days: 7

      - name: Add job summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Knip Analysis Summary" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.knip-run.outputs.has_issues }}" == "true" ]; then
            echo "ðŸ” **Knip found unused code**" >> $GITHUB_STEP_SUMMARY
            echo "- Files: ${{ steps.knip-run.outputs.unused_files }}" >> $GITHUB_STEP_SUMMARY
            echo "- Dependencies: ${{ steps.knip-run.outputs.unused_deps }}" >> $GITHUB_STEP_SUMMARY
            echo "- Exports: ${{ steps.knip-run.outputs.unused_exports }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.apply-fixes.outputs.changes_made }}" == "true" ]; then
              echo "âœ… **PR created for cleanup**" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ **No changes needed** - Knip didn't make any modifications" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ¨ **No unused code found** - Repository is clean!" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    needs: [release, deploy]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    if: always()

    steps:
      - name: Delete temporary artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            dist-${{ github.sha }}
            dist-release-${{ github.run_id }}
            coverage-*-${{ github.sha }}
            knip-report-${{ github.run_id }}
          failOnError: false
