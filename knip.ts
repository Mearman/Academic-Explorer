import type { KnipConfig } from "knip";

/**
 * Knip configuration for Academic Explorer monorepo
 *
 * Simplified configuration focusing on core unused file/dependency detection
 * without complex plugin configurations that may have path issues.
 */
const config: KnipConfig = {
  ignore: [
    // Test utilities and helpers (intentionally exported for reuse)
    "**/__tests__/utils/**",
    "**/__tests__/mocks/**",
    "**/test-*.ts",
    "**/*.test-helpers.ts",
    // Library exports (used by external consumers)
    "packages/*/src/index.ts",
    "packages/*/src/**/index.ts",
    // Package.json files with library entries
    "packages/*/package.json",
    // Test setup files referenced in vitest config
    "apps/web/src/test/setup.ts",
    "apps/web/src/test/component-setup.ts",
    "apps/web/src/test/e2e-setup.ts",
    // Development utility files (may be used in future development)
    "packages/client/src/advanced-field-selection.ts",
    "packages/client/src/cached-client.ts",
    "packages/client/src/type-guards.ts",
    // UI components that are exported but not currently used in web app
    "packages/ui/src/components/cards/AuthorCard.tsx",
    "packages/ui/src/components/cards/WorkCard.tsx",
    "packages/ui/src/components/cards/SourceCard.tsx",
    "packages/ui/src/components/cards/InstitutionCard.tsx",
    "packages/ui/src/components/cards/TopicCard.tsx",
    "packages/ui/src/components/cards/PublisherCard.tsx",
    "packages/ui/src/components/cards/FunderCard.tsx",
    "packages/ui/src/components/cards/examples.tsx",
    // Filter system components (built but not integrated)
    "apps/web/src/components/filters/**",
    // Search components (built but not integrated)
    "apps/web/src/components/search/AdvancedQueryBuilder.tsx",
    "apps/web/src/components/search/OpenAlexFilters.tsx",
    "apps/web/src/components/search/UnifiedSearch.tsx",
    "apps/web/src/components/search/VisualQueryBuilder.tsx",
    "apps/web/src/components/search/VisualQueryBuilder.example.tsx",
    // Test infrastructure exports (intentionally exported for test reuse)
    "packages/graph/src/__tests__/**/*.ts",
  ],
  ignoreExportsUsedInFile: true,
  // Research project settings - be more lenient with unused exports
  includeEntryExports: false,
  workspaces: {
    // Root workspace - scripts and configs
    ".": {
      entry: [
        "tools/scripts/*.{ts,js}",
        "config/shared.ts",
        "config/vite-plugins/static-data-index.ts",
        "vite.config.base.ts",
        "nx.json",
      ],
      project: ["tools/scripts/**/*.{ts,js}", "config/**/*.ts", "*.{ts,js}"],
    },

    // Web application
    "apps/web": {
      entry: [
        "src/main.tsx",
        "src/test/setup.ts",
        "src/test/component-setup.ts",
        "src/test/e2e-setup.ts",
        "src/test/msw/server.ts",
        "src/test/msw/handlers.ts",
        "src/build-plugins/openalex-data-plugin.ts",
        "src/stores/data-fetching-progress-store.ts",
      ],
      project: ["src/**/*.{ts,tsx}"],
      ignore: [
        "src/routeTree.gen.ts", // Generated by TanStack Router
        "src/**/*.{test,spec}.{ts,tsx}",
        "e2e/**/*",
        // Future features not currently integrated
        "src/components/filters/**",
        "src/components/search/AdvancedQueryBuilder.tsx",
        "src/components/search/OpenAlexFilters.tsx",
        "src/components/search/UnifiedSearch.tsx",
        "src/components/search/VisualQueryBuilder.tsx",
        "src/components/search/VisualQueryBuilder.example.tsx",
        "src/components/ApiCallTracker.tsx",
        "src/utils/navigation-tracker.ts",
        "src/workers/**",
      ],
    },

    // CLI application
    "apps/cli": {
      entry: ["src/simple-cli.ts"],
      project: ["src/**/*.ts"],
      ignore: ["src/**/*.{test,spec}.ts"],
    },

    // Graph package
    "packages/graph": {
      project: ["src/**/*.ts"],
    },

    // Simulation package
    "packages/simulation": {
      project: ["src/**/*.ts"],
    },

    // OpenAlex client package
    "packages/client": {
      entry: ["src/index.ts"],
      project: ["src/**/*.ts"],
    },

    // UI components package
    "packages/ui": {
      entry: ["src/index.ts", "src/test/setup.ts"],
      project: ["src/**/*.{ts,tsx}"],
      ignore: [
        "src/**/*.stories.{ts,tsx}", // Storybook stories
        "src/**/*.{test,spec}.{ts,tsx}",
        // Specialized card components (future features)
        "src/components/cards/AuthorCard.tsx",
        "src/components/cards/WorkCard.tsx",
        "src/components/cards/SourceCard.tsx",
        "src/components/cards/InstitutionCard.tsx",
        "src/components/cards/TopicCard.tsx",
        "src/components/cards/PublisherCard.tsx",
        "src/components/cards/FunderCard.tsx",
        "src/components/cards/examples.tsx",
        // Library components exported but not yet used in web app
        "src/components/data-display/BaseTable.tsx",
        "src/components/data-display/index.ts",
        "src/components/feedback/ErrorBoundary/ErrorBoundary.tsx",
        "src/components/feedback/ErrorBoundary/index.ts",
        "src/components/feedback/index.ts",
        "src/components/layout/CollapsibleSection.tsx",
        "src/components/layout/index.ts",
        "src/components/section-kit/BulkActionToolbar.tsx",
        "src/components/section-kit/EntityCollectionList.tsx",
        "src/components/section-kit/index.ts",
      ],
    },

    // Shared utilities package
    "packages/utils": {
      project: ["src/**/*.ts"],
    },
  },

  // Global ignore patterns
  ignore: [
    "**/dist/**",
    "**/coverage/**",
    "**/.nx/**",
    "**/node_modules/**",
    "**/.tmp/**",
    "**/.cache/**",
    ".github/**", // GitHub workflows contain complex YAML that can confuse knip
    ".github/workflows/**",
  ],

  // Ignore dependencies that are used but not detected correctly
  ignoreDependencies: [
    "@vanilla-extract/vite-plugin", // Used in vite.config.ts but knip doesn't detect it properly
    "@mantine/notifications", // Optional peerDependency for UI components
    "@tanstack/react-table", // Used by BaseTable component in UI package
    // Module resolution dependencies added for runtime and test environments
    "@types/d3-force", // Type definitions for d3-force used in graph visualizations
    "@types/d3-random", // Type definitions for d3-random used in force simulations
    "@types/lodash-es", // Type definitions for lodash-es utility functions
    "d3-force", // Force simulation library used in graph components
    "d3-random", // Random number generation for deterministic layouts
    "idb", // IndexedDB wrapper used for browser storage
    "lodash-es", // ES module utilities used across applications
    // Workspace dependencies that may not be actively used but are part of development
    "@academic-explorer/utils", // Utility package used across workspace projects
  ],

  // Plugin configurations
  eslint: {
    config: [
      "eslint.config.base.ts",
      "eslint.config.react.ts",
      "apps/*/eslint.config.ts",
      "packages/*/eslint.config.ts",
    ],
  },
  vitest: {
    config: [
      "vitest.config.base.ts",
      "vitest.config.react.ts",
      "apps/*/vitest.config.ts",
      "packages/*/vitest.config.ts",
    ],
  },

  // Re-enable vite plugin for better analysis
  vite: true,
  playwright: false,
};

export default config;
