# Data Model: TypeScript Configuration & Compilation Artifacts

**Feature**: Fix Vite/TypeScript In-Place Compilation Issue
**Date**: 2025-11-11
**Branch**: `003-fix-vite-compilation`

## Overview

This document models the structure of TypeScript configuration files and the compilation artifacts they produce. Understanding these entities and their relationships is critical for preventing in-place compilation.

## Entity Definitions

### 1. TypeScript Configuration File (tsconfig)

A JSON file that controls TypeScript compiler behavior.

**Attributes**:
- `path`: string - Absolute file path (e.g., `/path/to/tsconfig.json`)
- `extends`: string | undefined - Path to parent config to inherit from
- `compilerOptions`: CompilerOptions - Compilation settings
- `include`: string[] - Glob patterns for files to include
- `exclude`: string[] - Glob patterns for files to exclude
- `references`: ProjectReference[] - Dependencies on other TypeScript projects
- `files`: string[] | undefined - Explicit list of files to include

**Types**:
```typescript
interface TypeScriptConfig {
  path: string;
  extends?: string;
  compilerOptions: CompilerOptions;
  include?: string[];
  exclude?: string[];
  references?: ProjectReference[];
  files?: string[];
}

interface CompilerOptions {
  // Emit control
  noEmit?: boolean;           // If true, no .js files generated
  outDir?: string;            // Output directory for .js files
  declarationDir?: string;    // Output directory for .d.ts files
  declaration?: boolean;      // Generate .d.ts files
  declarationMap?: boolean;   // Generate .d.ts.map files
  sourceMap?: boolean;        // Generate .js.map files

  // Project references
  composite?: boolean;        // Enable project references

  // Module resolution
  baseUrl?: string;
  paths?: Record<string, string[]>;
  rootDir?: string;           // Root of source files

  // Build info
  tsBuildInfoFile?: string;   // Location of incremental build cache
  incremental?: boolean;      // Enable incremental compilation

  // Other options...
}

interface ProjectReference {
  path: string;  // Path to referenced project's tsconfig
}
```

**Relationships**:
- One tsconfig MAY extend another tsconfig (inheritance)
- One tsconfig MAY reference multiple other tsconfigs (project references)
- One tsconfig compiles to multiple CompilationArtifacts (one per source file)

**Validation Rules**:
- If `references` is non-empty, `composite` MUST be true in referenced projects
- If `composite` is true, `declaration` MUST be true
- `outDir` MUST NOT point to a directory containing source files
- If `noEmit` is true, `outDir`, `declarationDir` are ignored
- A project referenced by another project MUST NOT have `noEmit: true`

---

### 2. Compilation Artifact

A file generated by TypeScript compiler from source files.

**Attributes**:
- `path`: string - Absolute file path
- `type`: 'javascript' | 'declaration' | 'sourcemap' | 'buildinfo' - Artifact type
- `sourceFile`: string - Path to original .ts/.tsx file that generated this artifact
- `size`: number - File size in bytes
- `mtime`: Date - Last modified time

**Types**:
```typescript
interface CompilationArtifact {
  path: string;
  type: 'javascript' | 'declaration' | 'sourcemap' | 'buildinfo';
  sourceFile: string;
  size: number;
  mtime: Date;
}
```

**Subtypes**:

#### JavaScript Artifact (.js)
- Generated when `noEmit` is false or omitted
- Contains transpiled JavaScript code
- Location controlled by `outDir`

#### Declaration Artifact (.d.ts)
- Generated when `declaration` is true
- Contains type definitions
- Location controlled by `declarationDir` or `outDir`
- Required for TypeScript project references

#### Source Map Artifact (.js.map or .d.ts.map)
- Generated when `sourceMap` or `declarationMap` is true
- Maps compiled code back to source for debugging
- Location mirrors corresponding .js or .d.ts file

#### Build Info Artifact (.tsbuildinfo)
- Generated when `incremental` is true
- Contains compilation cache for incremental builds
- Location controlled by `tsBuildInfoFile`

**Relationships**:
- One source file (.ts/.tsx) MAY produce multiple CompilationArtifacts (.js, .d.ts, .js.map, .d.ts.map)
- One TypeScriptConfig MAY produce one BuildInfo artifact
- CompilationArtifacts MUST be deleted when source file is deleted (orphan check)

**Validation Rules**:
- Artifact path MUST be within `outDir` or `declarationDir` (not in-place with source)
- JavaScript artifact MUST NOT exist if `noEmit: true`
- Declaration artifact MUST NOT exist if `declaration: false`
- Source map MUST NOT exist if `sourceMap: false` (or `declarationMap: false` for .d.ts.map)

---

### 3. Package

A monorepo package with its own tsconfig and dependencies.

**Attributes**:
- `name`: string - Package name (e.g., "@academic-explorer/web")
- `path`: string - Absolute path to package directory
- `tsconfigs`: TypeScriptConfig[] - Config files in this package
- `dependencies`: Package[] - Other packages this depends on
- `distPath`: string - Path to build output directory (dist/)

**Types**:
```typescript
interface Package {
  name: string;
  path: string;
  tsconfigs: TypeScriptConfig[];
  dependencies: Package[];
  distPath: string;
}
```

**Relationships**:
- One Package HAS multiple TypeScriptConfigs (tsconfig.json, tsconfig.build.json, etc.)
- One Package MAY depend on multiple other Packages (via project references)
- One Package produces CompilationArtifacts in its distPath

**Validation Rules**:
- Package MUST have at least one tsconfig file
- If Package A references Package B, Package B's dist/ MUST contain declaration files
- Package dist/ MUST be .gitignored
- Package src/ MUST NOT contain any CompilationArtifacts

---

## State Model

### Compilation States

A source file can be in one of several compilation states:

```typescript
type CompilationState =
  | 'uncompiled'       // Source file exists, no artifacts
  | 'clean'            // Source compiled to dist/, no in-place artifacts
  | 'dirty-in-place'   // PROBLEM: Source compiled in-place (artifact in src/)
  | 'stale'            // Artifact older than source, needs recompilation
  | 'cached'           // Artifact up-to-date, matches source

interface SourceFile {
  path: string;
  mtime: Date;
  compilationState: CompilationState;
  artifacts: CompilationArtifact[];
}
```

**State Transitions**:

1. `uncompiled` → `clean`:
   - Trigger: TypeScript compiler runs with `outDir` set to dist/
   - Result: Artifacts created in dist/, none in src/

2. `uncompiled` → `dirty-in-place`:
   - Trigger: TypeScript compiler runs WITHOUT `outDir` (or `outDir: "."`)
   - Result: Artifacts created alongside source (PROBLEM STATE)

3. `clean` → `stale`:
   - Trigger: Source file modified (mtime changes)
   - Result: Existing artifacts in dist/ older than source

4. `stale` → `clean`:
   - Trigger: Recompilation runs
   - Result: Artifacts in dist/ updated

5. `dirty-in-place` → `clean`:
   - Trigger: In-place artifacts deleted AND tsconfig fixed
   - Result: Compilation produces only dist/ artifacts

6. `clean` → `cached`:
   - Trigger: Vite HMR caches dist/ artifacts
   - Result: Fast subsequent loads

**Goal State**: All source files in `clean` or `cached` state. Zero files in `dirty-in-place` state.

---

## File System Layout

### Current State (PROBLEM)

```
apps/web/
├── src/
│   ├── components/
│   │   ├── AddToListModal.tsx         # Source file
│   │   ├── AddToListModal.js          # ❌ PROBLEM: In-place artifact
│   │   ├── AddToListModal.js.map      # ❌ PROBLEM: In-place artifact
│   │   ├── AddToListModal.d.ts        # ❌ PROBLEM: In-place artifact
│   │   └── AddToListModal.d.ts.map    # ❌ PROBLEM: In-place artifact
│   └── lib/
│       └── utils/
│           ├── logger.ts              # Source file
│           ├── logger.js              # ❌ PROBLEM: In-place artifact
│           └── logger.d.ts            # ❌ PROBLEM: In-place artifact
├── dist/                              # ✅ CORRECT: Build artifacts here
├── node_modules/
│   └── .vite/                         # ✅ CORRECT: Vite cache here
└── tsconfig.json
```

### Target State (FIXED)

```
apps/web/
├── src/
│   ├── components/
│   │   └── AddToListModal.tsx         # ✅ Only source files
│   └── lib/
│       └── utils/
│           └── logger.ts              # ✅ Only source files
├── dist/
│   ├── AddToListModal.js              # ✅ CORRECT: Compiled artifacts in dist/
│   ├── AddToListModal.js.map
│   ├── AddToListModal.d.ts
│   ├── AddToListModal.d.ts.map
│   ├── logger.js
│   ├── logger.js.map
│   ├── logger.d.ts
│   └── logger.d.ts.map
├── node_modules/
│   └── .vite/                         # ✅ Vite cache (transient)
├── tsconfig.json                      # ✅ Dev config (noEmit: true)
└── tsconfig.build.json                # ✅ Build config (outDir: dist)
```

---

## Configuration Patterns

### Pattern 1: Dev Configuration (Type Checking Only)

**Purpose**: Fast type checking during development, no file emission

**File**: `apps/web/tsconfig.json`

```json
{
  "extends": "../../tsconfig.app.json",
  "compilerOptions": {
    "baseUrl": ".",
    "noEmit": true,  // KEY: No files emitted during dev
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"]
}
```

**Used By**:
- IDE/editor type checking
- `pnpm typecheck` command
- Pre-commit hooks

**Artifacts Produced**: None (noEmit: true)

**Compilation State**: Source files remain in `uncompiled` state

---

### Pattern 2: Build Configuration (Production Compilation)

**Purpose**: Generate JavaScript and declaration files for production and project references

**File**: `apps/web/tsconfig.build.json`

```json
{
  "extends": "./tsconfig.json",  // Inherit from dev config
  "compilerOptions": {
    "noEmit": false,              // KEY: Override noEmit to generate files
    "composite": true,            // Enable project references
    "declaration": true,          // Generate .d.ts for types
    "declarationMap": true,       // Generate .d.ts.map for source maps
    "outDir": "./dist",           // KEY: All artifacts go to dist/
    "rootDir": "./src",           // Source root for path mapping
    "sourceMap": true,            // Generate .js.map
    "incremental": true,          // Enable incremental builds
    "tsBuildInfoFile": "./dist/.tsbuildinfo"
  }
}
```

**Used By**:
- `pnpm build` command
- Production deployment pipeline
- Other packages referencing this package (via project references)

**Artifacts Produced**:
- dist/**/*.js (transpiled JavaScript)
- dist/**/*.d.ts (type declarations)
- dist/**/*.js.map (source maps)
- dist/**/*.d.ts.map (declaration maps)
- dist/.tsbuildinfo (incremental build cache)

**Compilation State**: Source files transition to `clean` state (artifacts in dist/)

---

### Pattern 3: Referenced Configuration (Dependencies)

**Purpose**: Allow other packages to use types from this package

**File**: `tools/tsconfig.json`

```json
{
  "compilerOptions": {
    "composite": true
  },
  "references": [
    { "path": "../apps/web" }  // Points to apps/web directory
  ]
}
```

**Resolution**:
1. TypeScript sees reference to ../apps/web
2. Looks for tsconfig.json in that directory
3. Follows project references (sees apps/web/tsconfig.build.json via composite)
4. Finds declaration files in apps/web/dist/*.d.ts
5. Uses those declarations for type checking

**Requirements**:
- Referenced project (apps/web) MUST have `composite: true` in build config
- Referenced project MUST have `declaration: true` in build config
- Referenced project MUST have been built (dist/*.d.ts files exist)

---

## Validation Queries

### Query 1: Find In-Place Artifacts (Problem Detection)

```bash
find apps/web/src -type f \( -name "*.js" -o -name "*.js.map" -o -name "*.d.ts" \) \
  ! -name "*.test.js" \
  ! -name "*.config.js"
```

**Expected Result After Fix**: Empty (no files found)

---

### Query 2: Verify Dist Artifacts Exist

```bash
ls -la apps/web/dist/ | grep -E "\.(js|d\.ts|js\.map)$"
```

**Expected Result After Fix**: List of compiled artifacts with recent timestamps

---

### Query 3: Check tsconfig noEmit Setting

```bash
cat apps/web/tsconfig.json | jq '.compilerOptions.noEmit'
```

**Expected Result**: `true` (dev config)

```bash
cat apps/web/tsconfig.build.json | jq '.compilerOptions.noEmit'
```

**Expected Result**: `false` or `null` (build config allows emit)

---

### Query 4: Verify Project Reference Chain

```bash
cat tools/tsconfig.json | jq '.references[].path'
```

**Expected Result**: `"../apps/web"` (or similar path to apps/web)

```bash
cat apps/web/tsconfig.build.json | jq '.compilerOptions.composite'
```

**Expected Result**: `true` (enables project references)

---

## Success Criteria Mapping

This data model directly supports the following success criteria:

- **SC-005**: File system search for `.js` files in `src/**/*.js` returns 0 results
  - Validation: Query 1 returns empty
  - State: All SourceFiles in `clean` or `uncompiled` state, zero in `dirty-in-place`

- **SC-006**: Git status shows 0 untracked compiled artifacts in src/
  - Validation: `git status --porcelain | grep "src/.*\.js"` returns empty
  - State: .gitignore contains patterns for all CompilationArtifact types

- **SC-003**: Production build completes with 0 TypeScript emit errors
  - Validation: Package build succeeds with tsconfig.build.json
  - State: All ProjectReferences resolved correctly

- **SC-002**: 100% of E2E tests see latest code changes
  - Validation: SourceFiles in `clean` state, Vite serves from memory/cache
  - State: No `dirty-in-place` files blocking HMR

---

## Implementation Impact

**Files Modified**:
- `.gitignore` - Add patterns for in-place artifacts
- `apps/web/tsconfig.json` - Ensure noEmit: true
- `apps/web/tsconfig.build.json` - Create with composite, declaration, outDir
- `apps/web/package.json` - Update build script to use tsconfig.build.json

**Files Created**:
- `apps/web/tsconfig.build.json` - New build configuration

**Files Deleted**:
- All .js, .js.map, .d.ts files in apps/web/src/ (one-time cleanup)

**No Files Modified in**:
- `vite.config.ts` - Vite configuration already correct
- `packages/*/` - No changes to other packages
- `tools/tsconfig.json` - Project reference already correct

---

## Glossary

- **In-place compilation**: TypeScript emitting .js files in the same directory as .ts source files
- **Project reference**: TypeScript feature allowing one project to depend on another's type declarations
- **Composite mode**: TypeScript setting that enables project references and incremental builds
- **noEmit**: TypeScript option that skips JavaScript generation (type checking only)
- **outDir**: TypeScript option specifying where to emit compiled JavaScript
- **declarationDir**: TypeScript option specifying where to emit type declarations (.d.ts)
- **HMR (Hot Module Replacement)**: Vite feature that updates modules in browser without full reload
- **Build artifact**: Any file generated by compilation process (opposed to source files)
