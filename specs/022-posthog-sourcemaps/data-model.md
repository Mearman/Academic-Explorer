# Data Model: PostHog Source Map Upload

**Feature**: 022-posthog-sourcemaps
**Phase**: 1 - Design & Contracts
**Date**: 2025-11-21

## Overview

This feature involves build artifacts and CI/CD configuration rather than runtime application data. The "entities" here are conceptual representations of build outputs and PostHog cloud resources, not application domain models requiring TypeScript interfaces.

## Conceptual Entities

### Release

Represents a deployed version of BibGraph with associated source maps.

**Attributes**:
- `version: string` - Git commit SHA (e.g., `a1b2c3d4e5f6...`)
- `timestamp: ISO8601 DateTime` - When source maps were uploaded
- `projectId: string` - PostHog project identifier (from `POSTHOG_CLI_ENV_ID`)
- `fileCount: number` - Number of source map files uploaded
- `status: 'uploaded' | 'failed'` - Upload status

**Lifecycle**:
1. Created when `posthog-cli sourcemap inject` adds release metadata to built JS files
2. Finalized when `posthog-cli sourcemap upload` completes successfully
3. Visible in PostHog dashboard under "Project Settings → Symbol Sets"
4. Persists indefinitely in PostHog cloud (retention controlled by PostHog settings)

**Source**: Not stored in application. Managed by PostHog cloud service. Viewable via PostHog dashboard.

**Relationships**:
- Has many SourceMapFile (1:N relationship)
- Belongs to one PostHog Project (N:1 relationship)

---

### SourceMapFile

Represents an individual `.map` file containing mappings between minified and original code.

**Attributes**:
- `fileName: string` - Original source file path (e.g., `packages/graph/src/types.ts`)
- `bundleFileName: string` - Minified bundle file name (e.g., `main-a1b2c3.js`)
- `chunkId: string` - Vite chunk identifier (e.g., `main`, `vendor`, `async-123`)
- `size: number` - File size in bytes
- `uploadedAt: ISO8601 DateTime` - When uploaded to PostHog

**Lifecycle**:
1. Generated by Vite during build process (`pnpm build`)
2. Written to `apps/web/dist/assets/*.map`
3. Injected with release metadata by `posthog-cli sourcemap inject`
4. Uploaded to PostHog by `posthog-cli sourcemap upload`
5. Deleted from filesystem by `--delete-after` flag
6. Available in PostHog for error stack trace deobfuscation

**Source**: Build artifact (temporary filesystem storage, permanent PostHog cloud storage)

**Relationships**:
- Belongs to one Release (N:1 relationship)
- Maps to one Bundle File (1:1 relationship)

---

### SymbolSet (PostHog Terminology)

PostHog's internal concept grouping all source maps for a single release.

**Attributes**:
- `releaseVersion: string` - Matches Release.version (git commit SHA)
- `files: SourceMapFile[]` - Array of uploaded source map files
- `createdAt: ISO8601 DateTime` - When symbol set was created
- `projectId: string` - PostHog project identifier

**Source**: PostHog cloud storage. Not directly accessible via API. Viewable in PostHog dashboard.

**Note**: This is a PostHog platform concept, not an application entity. Included for conceptual completeness.

---

## Build Artifacts (File System)

These are temporary files generated during CI/CD build process.

### Source Map File Structure

```
apps/web/dist/
├── assets/
│   ├── main-a1b2c3.js              # Minified bundle
│   ├── main-a1b2c3.js.map          # Source map (generated by Vite)
│   ├── vendor-d4e5f6.js            # Vendor bundle
│   ├── vendor-d4e5f6.js.map        # Vendor source map
│   ├── Graph-g7h8i9.js             # Async chunk
│   └── Graph-g7h8i9.js.map         # Async chunk source map
└── index.html                       # Entry HTML
```

### Source Map File Format (JSON)

Standard Source Map v3 format:

```json
{
  "version": 3,
  "file": "main-a1b2c3.js",
  "sourceRoot": "",
  "sources": [
    "../../packages/graph/src/types.ts",
    "../../apps/web/src/components/Graph.tsx",
    "..."
  ],
  "sourcesContent": ["..."],
  "mappings": "AAAA,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC;;AAE3B,OAAO,EAAE...",
  "names": ["React", "useState", "..."]
}
```

**After `posthog-cli sourcemap inject`**, JS bundles gain metadata:

```javascript
// At end of main-a1b2c3.js
//# sourceMappingURL=main-a1b2c3.js.map
//# postHogRelease=a1b2c3d4e5f6...
//# postHogChunkId=main
```

---

## Configuration Entities

### GitHub Actions Secrets

Environment variables required for source map upload:

| Secret Name | Type | Description | Example Value |
|-------------|------|-------------|---------------|
| `POSTHOG_CLI_ENV_ID` | string | PostHog project ID | `phc_abc123...` |
| `POSTHOG_CLI_TOKEN` | string | PostHog API token | `phx_xyz789...` (requires `error tracking write` + `organization read` scopes) |

**Storage**: GitHub repository secrets (encrypted at rest)

**Access**: Available in GitHub Actions as `${{ secrets.SECRET_NAME }}`

**Validation**: PostHog CLI will fail with clear error if invalid/missing

---

### Vite Configuration

**File**: `apps/web/vite.config.ts`

**Relevant Section**:
```typescript
export default defineConfig({
  build: {
    sourcemap: true, // NEW: Enable source map generation
    // ... existing build config
  },
  // ... rest of config
})
```

**Type**: TypeScript configuration object (typed by Vite)

**Validation**: TypeScript compiler enforces valid configuration structure

---

## State Transitions

### Source Map Upload Workflow State Machine

```
[Build Started]
    ↓
[Vite Generates Source Maps] ── (sourcemap: true)
    ↓
[Source Maps Written to Disk] ── (apps/web/dist/assets/*.map)
    ↓
[PostHog CLI Injects Metadata] ── (posthog-cli sourcemap inject)
    ↓
[Metadata Added to Bundles] ── (//# postHogRelease=...)
    ↓
[PostHog CLI Uploads Maps] ── (posthog-cli sourcemap upload)
    ↓
[Maps Stored in PostHog Cloud] ── (SymbolSet created)
    ↓
[Source Maps Deleted Locally] ── (--delete-after)
    ↓
[Deployment Proceeds] ── (GitHub Pages publish)
    ↓
[Production Errors Are Deobfuscated] ── (PostHog matches release version)
```

**Error Paths**:
- If upload fails → workflow fails → deployment blocked
- If authentication fails → clear error message → workflow fails
- If PostHog service unavailable → CLI retries → eventually fails → workflow fails

---

## Validation Rules

### Release Version

- **Format**: Git commit SHA (40-character hexadecimal string)
- **Source**: `$GITHUB_SHA` environment variable
- **Validation**: Automatically valid (GitHub provides)
- **Uniqueness**: Guaranteed unique per commit

### Source Map Files

- **Format**: Valid Source Map v3 JSON
- **Size**: Typically 500KB - 5MB per file (no explicit limit)
- **Count**: Expected 10-50 files for BibGraph monorepo
- **Validation**: Performed by PostHog CLI during upload

### API Credentials

- **POSTHOG_CLI_ENV_ID**: Must start with `phc_` prefix
- **POSTHOG_CLI_TOKEN**: Must have `error tracking write` + `organization read` scopes
- **Host**: Must be `https://eu.posthog.com` (EU instance)

**Validation**: PostHog CLI performs authentication check before upload

---

## No Runtime Data Models

**Important**: This feature does NOT introduce new TypeScript interfaces, classes, or runtime data structures to the BibGraph application. All "entities" above are:
- Build artifacts (temporary files)
- CI/CD configuration (YAML, environment variables)
- External service data (PostHog cloud storage)

The application code remains unchanged except for Vite configuration.

---

## References

- [Source Map v3 Specification](https://sourcemaps.info/spec.html)
- [PostHog Symbol Sets Documentation](https://posthog.com/docs/product-analytics/source-maps#viewing-source-maps)
- [Vite Build Options](https://vitejs.dev/config/build-options.html#build-sourcemap)
- [PostHog CLI Reference](https://posthog.com/docs/libraries/posthog-cli)
